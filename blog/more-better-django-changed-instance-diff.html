<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Django instance diff, now MORE BETTER!</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="Mostly typos, tech by Tim Watts." />
<meta name="author" content="Timothy John Watts" />
<link rel="stylesheet" href="/static/css/github.css" />
<link rel="stylesheet" href="/static/css/bootstrap.min.css" />
<link rel="stylesheet" href="/static/css/bootstrap-responsive.css" />
<style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
      .dark-grey {
        color: #4B4B4B;
      }
      footer {
        margin: 30px 0px;
        color: #AAA;
      }
      pre {
        margin: 20px;
      }
    </style>
<!--[if lt IE 9]&gt;
    &lt;script src="http://html5shim.googlecode.com/svn/trunk/html5.js"&gt;&lt;/script&gt;
    &lt;![endif]-->
<script src="/static/js/highlight.min.js"></script>
<script>
      hljs.initHighlightingOnLoad();

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-1049137-4']);
      _gaq.push(['_setDomainName', 'readevalprint.com']);
      _gaq.push(['_trackPageview']);

      var ga = document.createElement('script');
      ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(ga, s);
    </script>
</head>
<body class="container">
<div class="span7 offset2">
<header>
<h1><a href="/">read<span class="dark-grey">eval</span>print</a></h1>
</header><p>Program or be programmed.</p>
<time datetime="2011-5-20">May 20, 2011</time>
<h2>
    Django instance diff, now MORE BETTER!
  </h2>

<article>
</article><p>This will let you diff an object and its current state as saved in the
database. Or specify another arbitrary instance from a compleatly different
model to compare it to. Updated from my <a href="/blog/django-changed-instance-diff.html">last
post</a></p>
<p>After great feedback from Norm, I present a much more robust version.</p>
<pre><code>#!/usr/bin/env python

# By Tim Watts
# From http://readevalprint.com/blog/more-better-django-changed-instance-diff.html
# Updated on 9/22/2011 - Added Many2Many to supported fields
# Updated on 9/23/2011 - Fixed Many2Many fields

class Missing:
    pass

def diff(instance1, instance2=None, missing_field=None):
    '''
    Compares two instances and returns a dictionary of
    the different fields and a tuple of the corrisponding values.

    If a instance2 is not provided, the first instance is compared
    against the current values in the database.

    Set "missing_field" to differentiate between a field that doesn't
    exist and a field that contains a None.
    '''
    if not instance2:
        if not instance1.pk:
            return {}  # nothing to compare, dur.
        instance2 = instance1.__class__._default_manager.filter(pk=instance1.pk).get()
    d = {}
    for name, field in set(instance1._meta._name_map.items() + instance2._meta._name_map.items()):
        value1 = missing_field
        value2 = missing_field
        if field[0].__class__.__name__ == 'ManyToManyField':
            try:
                objects = getattr(instance1, name, missing_field)
                if objects != missing_field:
                    value1 = list(objects.values())
            except Exception as e:
                value1 = e
            try:
                objects = getattr(instance2, name, missing_field)
                if objects != missing_field:
                    value2 = list(objects.values())
            except Exception as e:
                value2 = e
        elif  field[0].__class__.__name__ not in ['OneToOneField', 'AutoField', 'RelatedField']:
            try:
                value1 = getattr(instance1, name, missing_field)
            except Exception as e:
                value1 = e
            try:
                value2 = getattr(instance2, name, missing_field)
            except Exception as e:
                value2 = e

        if value1 != value2:
            # do they break in the same way?
            if isinstance(value1, Exception) and isinstance(value2, Exception):
                if type(value1) != type(value2):
                    # different type of exceptions
                    d[name] = (value1, value2)
            else:
                # actually different values
                d[name] = (value1, value2)

    return d
</code></pre>
<p>UnitTests forthcoming...</p>
<p>Note: This WILL hit the database every single time if no second instance is supplied. Depending on
your logic, you may want to query a fresh copy from the database and keep
comparing to that.</p>

<footer> ReadEvalPrint is a series of typos by
          <a href="https://twitter.com/readevalprint">@readevalprint</a>. Enjoy yourself, it's a celebration! Powered by <a href="https://github.com/readevalprint/django-statomatic/">django-statomatic</a>. Dog fooding FTW!
        </footer>
</div>
</body>
</html>
