<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <title>Django instance diff</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Mostly typos, tech by Tim Watts.">
    <meta name="author" content="Timothy John Watts">
    <link rel="stylesheet" href="/static/css/github.css">
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/bootstrap-responsive.css">

    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
      .dark-grey {
        color: #4B4B4B;
      }
      footer {
        margin: 30px 0px;
        color: #AAA;
      }
      pre {
        margin: 20px;
      }
    </style>
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    
    

    <script src="/static/js/highlight.min.js"> </script>
    <script>
      hljs.initHighlightingOnLoad();

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-1049137-4']);
      _gaq.push(['_setDomainName', 'readevalprint.com']);
      _gaq.push(['_trackPageview']);

      var ga = document.createElement('script');
      ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(ga, s);
    </script>
  </head>
  <body class="container">
       <div class="span7 offset2">
        <header>
          
  
            <h1><a href='/'>read<span class="dark-grey">eval</span>print</a></h1>
            <p>Code: it pays the <strike>bills</strike> fun.</p>
          
  <time datetime="2011-5-19">May 19, 2011</time>
  <h2>
    Django instance diff
  </h2>


        </header>
        
<article>
<p>This will let you diff an object and its current state as saved in the
database. Or specify another arbitrary instance from a compleatly different
model to compare it to.</p>
<div class="alert-error alert">

<p>UPDATE May 20: Do not use this version. It's here merely for historical purposes. Check
out the <a href="/blog/more-better-django-changed-instance-diff.html">updated code here.</a></p>
</div>

<pre><code>def diff(instance1, instance2 = None):
    '''
    Returns a dictionary of tuples (old,new) for two arbitrary Django instances or an instance
    and the current data in the database
    '''
    if not instance2:
        if not instance1.pk:
            return {}  # nothing to compare, dur.
        instance2 = instance1.__class__._default_manager.filter(pk=instance1.pk).get()
    d = {}
    for field in set(instance1._meta.fields + instance2._meta.fields):
        value1 = getattr(instance1, field.name, None)
        value2 = getattr(instance2, field.name, None)
        if value1 != value2:
            d[field.name] = (value1, value2)
    return d
</code></pre>
<p>Some usage may include</p>

<pre><code class="python">In [87]: b = Bar.objects.get(id = 12)

In [88]: b.user
Out[88]: &lt;user: tim="tim"&gt;

In [89]: u = User.objects.get(username='bill')

In [90]: b.user = u

In [91]: diff(b)
Out[91]: {'user': (&lt;user: bill="bill"&gt;,&lt;user: tim="tim"&gt;)}

In [92]: 'user' in diff(b)
Out[92]: True
</code></pre>

<p>Or use in the <code>pre_save</code> method on your model if you only want to update
some data or flush a cache.</p>
<p>Note: This WILL hit the database every single time if no second instance is supplied. Depending on
your logic, you may want to query a fresh copy from the database and keep
comparing to that.</p>
</article>

        


        <footer> ReadEvalPrint is a series of typos by
          <a href="https://twitter.com/readevalprint">@readevalprint</a>. Enjoy yourself, it's a celebration!
        </footer>
      </div>
    </body>
  </html>
